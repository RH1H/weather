<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- links -->
    <link rel="icon" type="png" href="img/icon.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="css/style.css" />
    <!-- Title -->
    <title>Weather App</title>
    <style>
      /* Chatbot styles */
      .chatbot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        max-height: 400px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chatbot-header {
        background-color: #007bff;
        color: white;
        padding: 10px;
        text-align: center;
        font-weight: bold;
      }

      .chatbot-messages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
      }

      .chatbot-input {
        display: flex;
        border-top: 1px solid #ddd;
      }

      .chatbot-input input {
        flex: 1;
        padding: 10px;
        border: none;
        outline: none;
      }

      .chatbot-input button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px;
        cursor: pointer;
      }

      .chatbot-input button:hover {
        background-color: #0056b3;
      }

      .message {
        margin: 5px 0;
      }

      .message.user {
        text-align: right;
        color: #007bff;
      }

      .message.bot {
        text-align: left;
        color: #333;
      }
    </style>
  </head>

  <body>
    <div class="pc">
      <!-- nav section -->
      <nav>
        <ul>
          <li>
            <a class="active" href="index.html"
              ><i class="fa-solid fa-location-arrow"></i
            ></a>
          </li>
          <li>
            <a href="search.html"
              ><i class="fa-solid fa-magnifying-glass"></i
            ></a>
          </li>
          <li>
            <a href="world.html"><i class="fa-solid fa-earth-americas"></i></a>
          </li>
        </ul>
      </nav>
      <!-- main section -->
      <div id="screen">
        <!-- city name -->
        <div class="city-name">
          <i class="fa-solid fa-map-pin"></i>
          <h1 id="city-name">Mumbai</h1>
        </div>
        <!-- weather icon -->
        <div class="weather-icon-css">
          <img class="weather-icon" src="img/sun.png" />
        </div>
        <!-- weather details -->
        <div class="weather-description">
          <div class="show-metric" id="metric">0°</div>
          <div class="weather-details">
            <div class="weather-main" id="weather-main">Sunnen</div>
            <div class="h-f">
              <div class="show-humidity">H: <span id="humidity">60</span></div>
              ||
              <div class="show-humidity">
                F: <span id="feels-like">60</span>
              </div>
            </div>
          </div>
        </div>
        <!-- Today-forecast -->
        <div class="forcasts-box">
          <div class="today-forecast">
            <h4>TODAY</h4>
            <div class="weather-icon-today">
              <img class="weather-icons" src="img/sun.png" />
            </div>
            <div class="temp-today">
              <span id="temp-min-today">50°</span><span>/ </span
              ><span id="temp-max-today">55°</span>
            </div>
            <div class="weather-main-today" id="weather-main">Sunnen</div>
          </div>

          <!-- 5day Forecast -->
          <div class="forecast">
            <h5>6-DAYS FORECAST</h5>
            <div id="forecast-box"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chatbot -->
    <div class="chatbot-container" id="chatbot">
      <div class="chatbot-header">Weather Chatbot</div>
      <div class="chatbot-messages" id="chatbot-messages"></div>
      <div class="chatbot-input">
        <input type="text" id="chatbot-input" placeholder="Ask me about the weather..." />
        <button id="chatbot-send">Send</button>
      </div>
    </div>

    <!-- script -->
    <script>
      const chatbotMessages = document.getElementById('chatbot-messages');
      const chatbotInput = document.getElementById('chatbot-input');
      const chatbotSend = document.getElementById('chatbot-send');

      // Function to add a message to the chatbot
      function addMessage(content, sender) {
        const message = document.createElement('div');
        message.className = `message ${sender}`;
        message.textContent = content;
        chatbotMessages.appendChild(message);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
      }

      // Function to handle user input
      async function handleUserInput() {
        const userInput = chatbotInput.value.trim();
        if (!userInput) return;

        addMessage(userInput, 'user');
        chatbotInput.value = '';

        // Show a "typing..." indicator
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'message bot';
        typingIndicator.textContent = 'Typing...';
        chatbotMessages.appendChild(typingIndicator);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

        // Fetch bot response from Dialogflow API
        try {
          const botResponse = await getBotResponse(userInput);
          chatbotMessages.removeChild(typingIndicator);
          addMessage(botResponse, 'bot');
        } catch (error) {
          chatbotMessages.removeChild(typingIndicator);
          addMessage('Sorry, I am having trouble responding right now. Please try again later.', 'bot');
        }
      }

      // Function to fetch bot responses from Dialogflow API
      async function getBotResponse(input) {
        const projectId = 'YOUR_DIALOGFLOW_PROJECT_ID'; // Replace with your Dialogflow project ID
        const sessionId = '123456'; // Replace with a unique session ID
        const apiKey = 'YOUR_GOOGLE_API_KEY'; // Replace with your Google API key

        try {
          const response = await fetch(
            `https://dialogflow.googleapis.com/v2/projects/${projectId}/agent/sessions/${sessionId}:detectIntent`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${apiKey}`,
              },
              body: JSON.stringify({
                queryInput: {
                  text: {
                    text: input,
                    languageCode: 'en',
                  },
                },
              }),
            }
          );

          if (!response.ok) {
            const errorDetails = await response.json();
            console.error('API Error:', response.status, response.statusText, errorDetails);
            throw new Error(`API Error: ${errorDetails.error.message}`);
          }

          const data = await response.json();
          return data.queryResult.fulfillmentText || 'I am unable to fetch a response right now.';
        } catch (error) {
          console.error('Error fetching bot response:', error.message);
          return 'I am unable to fetch a response right now. Please try again later.';
        }
      }

      // Event listeners
      chatbotSend.addEventListener('click', handleUserInput);
      chatbotInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleUserInput();
      });
    </script>
  </body>
</html>
